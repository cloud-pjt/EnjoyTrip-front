name: Build and Push Vue Frontend to ECR
on:
  push:
    branches: [ "main" ]         # âœ devì— ìë™ ë°˜ì˜ (ë¹Œë“œ)
  workflow_dispatch:
    inputs:
      environment:
        description: "ë°°í¬ í™˜ê²½ ì„ íƒ"
        required: true
        default: "prod"
        type: choice
        options: [ "prod" ]
      image_tag:
        description: "DEV ì´ë¯¸ì§€ íƒœê·¸ (ë¹„ì›Œë‘ë©´ ìµœì‹  íƒœê·¸ ìë™ ì„ íƒ)"
        required: false
        type: string

jobs:
  build-dev:
    # DEV í™˜ê²½: ì‹¤ì œ ë¹Œë“œ + ECR ì—…ë¡œë“œ
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    env:
      ECR_REGISTRY: 255260635764.dkr.ecr.ap-northeast-2.amazonaws.com
      ECR_REPOSITORY: enjoy-front
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies and build
        run: |
          echo "VITE_KAKAO_MAP_API_SERVICE_KEY=${{ secrets.VITE_KAKAO_MAP_API_SERVICE_KEY }}" >> .env
          echo "VITE_VUE_API_URL=${{ secrets.VITE_VUE_API_URL }}" >> .env
          npm install
          npm run build
      
      - name: Get current time (KST)
        run: echo "IMAGE_TAG=$(TZ='Asia/Seoul' date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2
      
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push to DEV ECR
        run: |
          docker build \
          -f Dockerfile.dev \
          --build-arg VITE_VUE_API_URL=${{ secrets.VITE_VUE_API_URL }} \
          -t $ECR_REPOSITORY:${{ env.IMAGE_TAG }} .
          docker tag $ECR_REPOSITORY:${{ env.IMAGE_TAG }} $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.IMAGE_TAG }}
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.IMAGE_TAG }}
          echo "âœ… DEV ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ: $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.IMAGE_TAG }}"

      - name: Checkout manifests repo
        uses: actions/checkout@v4
        with:
          repository: cloud-pjt/enjoy-cd
          token: ${{ secrets.GH_PAT }}
          ref: develop
      
      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/
      
      - name: Update DEV kustomization
        run: |
          cd frontend/overlays/dev
          kustomize edit set image $ECR_REGISTRY/$ECR_REPOSITORY=$ECR_REGISTRY/$ECR_REPOSITORY:${{ env.IMAGE_TAG }}
          echo "ğŸ“ DEV kustomization ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          cat kustomization.yaml
      
      - name: Commit and push DEV changes  
        run: |
          git config user.name "sdpup"
          git config user.email "epflswu12@gmail.com"
          if ! git diff --quiet frontend/overlays/dev/; then
            git add frontend/overlays/dev/  # frontend í´ë”ë§Œ ì¶”ê°€
            git commit -m "ğŸ”§ Update DEV frontend image to ${{ env.IMAGE_TAG }}"
            git push origin develop
          else
            echo "No frontend changes to commit."
          fi
      
      - name: Display next steps
        run: |
          echo "ğŸ‰ DEV ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“‹ PROD ë°°í¬ë¥¼ ì›í•œë‹¤ë©´:"
          echo "   1. Actions íƒ­ì—ì„œ 'Build and Push Vue Frontend to ECR' ì›Œí¬í”Œë¡œìš° ì„ íƒ"
          echo "   2. 'Run workflow' í´ë¦­"  
          echo "   3. Image tagì— ì…ë ¥: ${{ env.IMAGE_TAG }}"
          echo "   4. Environment: prod ì„ íƒ í›„ ì‹¤í–‰"

  promote-to-prod:
    # PROD í™˜ê²½: DEV ì´ë¯¸ì§€ë¥¼ ë³µì‚¬í•˜ëŠ” ëŒ€ì‹  docker.prodë¡œ ì¬ë¹Œë“œ
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    env:
      ECR_REGISTRY: 255260635764.dkr.ecr.ap-northeast-2.amazonaws.com
      DEV_REPOSITORY: enjoy-front
      PROD_REPOSITORY: enjoy-front-prod

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Determine image tag to promote
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            IMAGE_TAG="${{ github.event.inputs.image_tag }}"
            echo "ğŸ¯ ì‚¬ìš©ì ì§€ì • íƒœê·¸ ì‚¬ìš©: $IMAGE_TAG"
          else
            IMAGE_TAG=$(aws ecr describe-images \
              --repository-name $DEV_REPOSITORY \
              --region ap-northeast-2 \
              --query 'sort_by(imageDetails,&imagePushedAt)[-1].imageTags[0]' \
              --output text)
            echo "ğŸ”„ ìµœì‹  DEV ì´ë¯¸ì§€ íƒœê·¸ ìë™ ì„ íƒ: $IMAGE_TAG"
          fi

          if [ "$IMAGE_TAG" = "null" ] || [ -z "$IMAGE_TAG" ]; then
            echo "âŒ ERROR: DEV ë ˆí¬ì§€í† ë¦¬ì—ì„œ ìœ íš¨í•œ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "âœ… ìŠ¹ê²©í•  ì´ë¯¸ì§€ íƒœê·¸: $IMAGE_TAG"

      # â¬‡ï¸ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (docker.prodì™€ í”„ë¡ íŠ¸ ì†ŒìŠ¤ê°€ í•„ìš”)
      - name: Checkout source
        uses: actions/checkout@v3
      # (ëª¨ë…¸ë¦¬í¬ì—ì„œ ë‹¤ë¥¸ í´ë”ë¼ë©´ path ì§€ì • ê°€ëŠ¥)
      # with:
      #   path: src

      # â¬‡ï¸ docker.prodë¡œ Multi-Stage ë¹Œë“œ & í‘¸ì‹œ (Node ì„¤ì¹˜/ë¹Œë“œ ë¶ˆí•„ìš”)
      - name: Build and push PROD image (Multi-Stage)
        run: |
          IMAGE_TAG=${{ steps.tag.outputs.IMAGE_TAG }}
          echo "ğŸ—ï¸ docker.prodë¥¼ ì‚¬ìš©í•´ ìš´ì˜ìš© ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."

          # docker.prodê°€ ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸ì— ìˆì„ ë•Œ
          docker build \
            -f Dockerfile.prod \
            --build-arg VITE_VUE_API_URL=${{ secrets.VITE_VUE_API_URL }} \
            --build-arg VITE_KAKAO_MAP_API_SERVICE_KEY=${{ secrets.VITE_KAKAO_MAP_API_SERVICE_KEY }} \
            -t $ECR_REGISTRY/$PROD_REPOSITORY:$IMAGE_TAG .

          docker push $ECR_REGISTRY/$PROD_REPOSITORY:$IMAGE_TAG
          echo "âœ… PROD Multi-Stage ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ: $ECR_REGISTRY/$PROD_REPOSITORY:$IMAGE_TAG"

    # â¬‡ï¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë ˆí¬ ì²´í¬ì•„ì›ƒ (ì‘ì—…ê³µê°„ ë®ì–´ì“°ê¸° í”¼í•˜ë ¤ë©´ path ì§€ì • ê¶Œì¥)
      - name: Checkout manifests repo
        uses: actions/checkout@v4
        with:
          repository: cloud-pjt/enjoy-cd
          token: ${{ secrets.GH_PAT }}
          path: cd-repo

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Update PROD kustomization
        working-directory: cd-repo/frontend/overlays/prod
        run: |
          IMAGE_TAG=${{ steps.tag.outputs.IMAGE_TAG }}
          kustomize edit set image $ECR_REGISTRY/$PROD_REPOSITORY=$ECR_REGISTRY/$PROD_REPOSITORY:$IMAGE_TAG
          echo "ğŸ“ PROD kustomization ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          cat kustomization.yaml

      - name: Commit and push PROD changes
        working-directory: cd-repo
        run: |
          git config user.name "sdpup"
          git config user.email "epflswu12@gmail.com"
          if ! git diff --quiet frontend/overlays/prod/; then
            git add frontend/overlays/prod/
            git commit -m "ğŸš€ Promote DEV image ${{ steps.tag.outputs.IMAGE_TAG }} to PROD (rebuild with docker.prod)"
            git push
            echo "âœ… PROD ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          else
            echo "No manifest changes to commit."
          fi

      - name: Deployment summary
        run: |
          IMAGE_TAG=${{ steps.tag.outputs.IMAGE_TAG }}
          echo "ğŸ‰ PROD ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“¦ ë°°í¬ëœ ì´ë¯¸ì§€: $ECR_REGISTRY/$PROD_REPOSITORY:$IMAGE_TAG"
          echo "ğŸ”— docker.prod(Multi-Stage)ë¡œ ì¬ë¹Œë“œëœ ì´ë¯¸ì§€ê°€ PRODì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤."
